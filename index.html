<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Encriptador — UI espacial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07091a;
      --card:#0e1330cc;
      --card-border: #2b35a8;
      --accent:#7aa2ff;
      --accent-2:#a36bff;
      --ok:#19d27c;
      --danger:#ff5670;
      --muted:#9aa3b2;
      --text:#e9ecff;
      --text-dim:#b9c1e0;
      --glass: blur(10px) saturate(120%);
      --radius: 20px;
      --shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Outfit", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, #0b1035 0%, transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, #1a0f3a 0%, transparent 60%),
                  radial-gradient(1200px 900px at 50% 120%, #10152f 0%, transparent 60%),
                  var(--bg);
      overflow-x: hidden;
    }
    /* Estrellas */
    .stars, .stars:before, .stars:after{
      position: fixed; inset:0; content:""; pointer-events:none;
      background:
        radial-gradient(2px 2px at 20% 30%, #fff8 50%, transparent 52%) repeat,
        radial-gradient(1px 1px at 80% 40%, #fff5 50%, transparent 52%) repeat,
        radial-gradient(1.5px 1.5px at 40% 80%, #fff6 50%, transparent 52%) repeat;
      background-size: 600px 600px, 800px 800px, 1000px 1000px;
      animation: drift 120s linear infinite;
      filter: drop-shadow(0 0 6px #a9bbff80);
    }
    .stars:before{animation-duration: 160s; opacity:.7}
    .stars:after{animation-duration: 200s; opacity:.5}
    @keyframes drift{
      from{transform: translate3d(0,0,0)}
      to{transform: translate3d(-300px, -200px, 0)}
    }

    header{
      position:relative; z-index:1; text-align:center; padding:48px 16px 8px;
    }
    .title{
      font-weight:800; letter-spacing:0.5px; font-size: clamp(28px, 4vw, 42px);
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 30px #7aa2ff33;
    }
    .subtitle{ color: var(--text-dim); margin-top:8px; }

    .grid{
      position:relative; z-index:1;
      display:grid; gap:24px; padding:32px 16px 64px; max-width:1200px; margin: 0 auto;
      grid-template-columns: repeat(auto-fit, minmax(310px, 1fr));
    }

    .card{
      position:relative; border-radius: var(--radius); background: var(--card);
      backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      border:1px solid rgba(122,162,255,.18);
      overflow:hidden;
    }
    .card:before{
      content:""; position:absolute; inset:-1px;
      border-radius: inherit;
      background: linear-gradient(160deg, #7aa2ff40, #a36bff20 40%, transparent 60%);
      pointer-events:none; mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
      -webkit-mask-composite: xor; mask-composite: exclude;
      padding:1px;
    }
    .card-header{
      padding:20px 22px 10px;
      display:flex; align-items:center; gap:12px;
    }
    .badge{
      font-size:12px; color:#0b1120; background: linear-gradient(90deg, var(--accent), var(--accent-2));
      padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:.3px;
      box-shadow: 0 6px 18px #7aa2ff44;
    }
    .card-title{ font-size:20px; font-weight:700; margin:0; }
    .card-desc{ color: var(--text-dim); font-size:14px; padding:0 22px 8px; }

    .card-body{ padding: 8px 22px 22px; display:flex; flex-direction:column; gap:14px;}
    label{font-size:13px; color: var(--muted); display:block; margin-bottom:6px}
    .field{
      display:flex; gap:10px; align-items:center; background: #0d132b; border:1px solid #1e2759;
      padding:10px 12px; border-radius: 14px;
    }
    input[type="file"], input[type="password"], input[type="text"]{
      flex:1; border:none; outline:none; background:transparent; color: var(--text);
      font-size:14px;
    }
    input::file-selector-button{
      background:linear-gradient(90deg, #1f2a61, #2a1f61);
      color: #e3e7ff; border: none; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .hint{font-size:12px; color: var(--muted); margin-top:-6px}

    .actions{display:flex; align-items:center; gap:12px; margin-top:6px}
    button{
      appearance:none; border:none; cursor:pointer; font-weight:700; letter-spacing:.3px;
      color:#0b1120; background: linear-gradient(90deg, var(--accent), var(--accent-2));
      padding:12px 16px; border-radius: 14px; box-shadow: 0 8px 24px #7aa2ff55;
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05);}
    button:disabled{ opacity:.65; cursor:not-allowed; transform:none}

    .progress{
      flex:1; display:flex; align-items:center; gap:10px;
    }
    progress{
      width:100%; height:10px; border: none; border-radius:16px; background:#0a0f24; overflow:hidden;
    }
    progress::-webkit-progress-bar{ background:#0a0f24 }
    progress::-webkit-progress-value{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .2s ease }
    progress::-moz-progress-bar{ background: linear-gradient(90deg, var(--accent), var(--accent-2)) }

    .status{ font-size:12px; color: var(--text-dim)}
    .divider{ height:1px; background: linear-gradient(90deg, transparent, #4051a680, transparent); margin: 6px 0 8px}
    .footer-hint{ color: var(--muted); text-align:center; font-size:12px; padding: 0 16px 16px}

    .chip{
      font-size:11px; color:#cfe1ff; background:#18204a; border:1px solid #2a3aa5; padding:6px 8px; border-radius:999px;
    }

    @media (min-width: 1100px){
      .card-body{min-height: 260px}
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <header>
    <div class="title">Proyecto Encriptador</div>
    <div class="subtitle">UI espacial con progreso de descarga en tiempo real</div>
  </header>

  <main class="grid">
    <!-- ENCRIPTAR -->
    <section class="card" id="card-encrypt">
      <div class="card-header">
        <span class="badge">AES-256-GCM</span>
        <h3 class="card-title">Encriptar archivo</h3>
      </div>
      <p class="card-desc">Sube un archivo y una contraseña. El backend devolverá el archivo encriptado.</p>
      <div class="card-body">
        <div class="field">
          <label for="enc-file">Archivo</label>
          <input id="enc-file" type="file" />
        </div>
        <div class="field">
          <label for="enc-pass">Contraseña</label>
          <input id="enc-pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
        </div>
        <div class="divider"></div>
        <div class="actions">
          <button id="enc-btn">Encriptar</button>
          <div class="progress" aria-live="polite">
            <progress id="enc-progress" value="0" max="100"></progress>
            <span id="enc-status" class="status">—</span>
          </div>
        </div>
        <div class="hint">Recomendado: contraseñas de al menos 12 caracteres.</div>
      </div>
      <div class="footer-hint">
        <span class="chip">Preserva filename de <code>Content-Disposition</code></span>
      </div>
    </section>

    <!-- DESENCRIPTAR -->
    <section class="card" id="card-decrypt">
      <div class="card-header">
        <span class="badge">AES-256-GCM</span>
        <h3 class="card-title">Desencriptar archivo</h3>
      </div>
      <p class="card-desc">Sube un archivo encriptado y su contraseña. Se descargará el original.</p>
      <div class="card-body">
        <div class="field">
          <label for="dec-file">Archivo encriptado</label>
          <input id="dec-file" type="file" />
        </div>
        <div class="field">
          <label for="dec-pass">Contraseña</label>
          <input id="dec-pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
        </div>
        <div class="divider"></div>
        <div class="actions">
          <button id="dec-btn">Desencriptar</button>
          <div class="progress" aria-live="polite">
            <progress id="dec-progress" value="0" max="100"></progress>
            <span id="dec-status" class="status">—</span>
          </div>
        </div>
        <div class="hint">El backend debe devolver <code>Content-Length</code> para progreso exacto.</div>
      </div>
      <div class="footer-hint">
        <span class="chip">Stream + % restante</span>
      </div>
    </section>

    <!-- ENCRIPTAMIENTO MASIVO -->
    <section class="card" id="card-massive">
      <div class="card-header">
        <span class="badge">ZIP stream</span>
        <h3 class="card-title">Encriptamiento masivo</h3>
      </div>
      <p class="card-desc">Sube múltiples archivos y, opcionalmente, un CSV (<em>file_name,password</em>).</p>
      <div class="card-body">
        <div class="field">
          <label for="mass-files">Archivos (múltiples)</label>
          <input id="mass-files" type="file" multiple />
        </div>
        <div class="field">
          <label for="mass-csv">CSV de contraseñas (opcional)</label>
          <input id="mass-csv" type="file" accept=".csv,text/csv" />
        </div>
        <div class="field">
          <label for="mass-pass">Contraseña única (si no usas CSV)</label>
          <input id="mass-pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
        </div>
        <div class="divider"></div>
        <div class="actions">
          <button id="mass-btn">Encriptar</button>
          <div class="progress" aria-live="polite">
            <progress id="mass-progress" value="0" max="100"></progress>
            <span id="mass-status" class="status">—</span>
          </div>
        </div>
        <div class="hint">El backend devolverá un ZIP en streaming.</div>
      </div>
      <div class="footer-hint">
        <span class="chip">Backpressure-friendly</span>
      </div>
    </section>
  </main>

  <script type="module">
    // =========================
    // CONFIG
    // =========================
    const API_BASE = 'http://localhost:3000/api'; // <- CAMBIA ESTO
    const ENDPOINTS = {
      encrypt: '/encryption_operations/v2/encrypt',
      decrypt: '/encryption_operations/v2/decrypt',
      massive: '/encryption_operations/v2/massive-encrypt'
    };
    const API_KEY = 'tenants API-Key 73e11a8e-81bf-4d72-9fd4-7df7a2bc3874'; // opcional, si tu backend lo requiere: 'tu_api_key'

    // =========================
    // UTILS
    // =========================
    const $ = (sel) => document.querySelector(sel);

    function parseFilenameFromCD(response) {
      const cd = response.headers.get('Content-Disposition') || '';
      // Soporta filename* (RFC 5987) y filename="..."
      let m = cd.match(/filename\*=(?:UTF-8'')?([^;]+)/i);
      if (m && m[1]) {
        try { return decodeURIComponent(m[1].replace(/["']/g, '').trim()); } catch { /* ignore */ }
      }
      m = cd.match(/filename="([^"]+)"/i) || cd.match(/filename=([^;]+)/i);
      if (m && m[1]) return m[1].trim().replace(/^utf-8''/i, '');
      return 'download.bin';
    }

    function bytes(n) {
      if (!n && n !== 0) return '—';
      const u = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(n)/Math.log(1024));
      return (n/Math.pow(1024, i)).toFixed(i ? 1 : 0) + ' ' + u[i];
    }

    function setBusy(button, busy) {
      button.disabled = !!busy;
    }

    function updateProgressUI(progressEl, statusEl, loaded, total) {
      if (total > 0) {
        const pct = Math.max(0, Math.min(100, Math.round(loaded / total * 100)));
        progressEl.max = 100;
        progressEl.value = pct;
        const remain = 100 - pct;
        statusEl.textContent = `${pct}% — faltan ${remain}% (${bytes(total - loaded)} de ${bytes(total)})`;
      } else {
        // Indeterminado
        progressEl.removeAttribute('max');
        progressEl.value = null;
        statusEl.textContent = `descargando... (${bytes(loaded)} recibidos)`;
      }
    }

    async function downloadWithProgress({url, formData, button, progressEl, statusEl, initialLabel}) {
      setBusy(button, true);
      progressEl.value = 0; progressEl.max = 100; statusEl.textContent = 'Iniciando…';
      button.textContent = 'Descargando…';

      const headers = {};
      if (API_KEY) headers['Authorization'] = API_KEY;

      const resp = await fetch(url, { method: 'POST', body: formData, headers });

      if (!resp.ok) {
        setBusy(button, false);
        button.textContent = initialLabel;
        const text = await resp.text().catch(()=>'');
        throw new Error(`HTTP ${resp.status}: ${text || resp.statusText}`);
      }

      const total = Number(resp.headers.get('Content-Length')) || 0;
      const reader = resp.body?.getReader?.();
      if (!reader) {
        // Navegador sin ReadableStream (poco probable)
        const blob = await resp.blob();
        return {blob, resp};
      }

      const chunks = [];
      let received = 0;
      updateProgressUI(progressEl, statusEl, received, total);

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.byteLength;
        updateProgressUI(progressEl, statusEl, received, total);

        const totalKnown = total > 0;
        if (totalKnown) {
          const pct = Math.round(received / total * 100);
          const remain = 100 - pct;
          button.textContent = `Descargando… ${remain}% restante`;
        } else {
          button.textContent = `Descargando…`;
        }
      }

      const blob = new Blob(chunks);
      return {blob, resp};
    }

    function triggerDownload(blob, response) {
      const filename = parseFilenameFromCD(response);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      return filename;
    }

    function resetUI(button, progressEl, statusEl, initialLabel){
      button.textContent = initialLabel;
      setBusy(button, false);
      progressEl.value = 0; progressEl.max = 100;
      statusEl.textContent = '—';
    }

    // =========================
    // ENCRIPTAR (single)
    // =========================
    (function setupEncrypt(){
      const fileEl = $('#enc-file');
      const passEl = $('#enc-pass');
      const btn = $('#enc-btn');
      const progressEl = $('#enc-progress');
      const statusEl = $('#enc-status');
      const initialLabel = 'Encriptar';

      btn.addEventListener('click', async () => {
        try{
          if (!fileEl.files?.length) throw new Error('Selecciona un archivo.');
          if (!passEl.value) throw new Error('Ingresa la contraseña.');
          const fd = new FormData();
          fd.append('password', passEl.value);
          fd.append('file', fileEl.files[0]);
          const {blob, resp} = await downloadWithProgress({
            url: API_BASE + ENDPOINTS.encrypt,
            formData: fd,
            button: btn,
            progressEl, statusEl,
            initialLabel
          });
          const name = triggerDownload(blob, resp);
          statusEl.textContent = `Completado: ${name}`;
          btn.textContent = 'Completado ✓';
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1200);
        }catch(err){
          console.error(err);
          statusEl.textContent = 'Error: ' + (err?.message || err);
          btn.textContent = 'Error';
          setBusy(btn, false);
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1500);
        }
      });
    })();

    // =========================
    // DESENCRIPTAR
    // =========================
    (function setupDecrypt(){
      const fileEl = $('#dec-file');
      const passEl = $('#dec-pass');
      const btn = $('#dec-btn');
      const progressEl = $('#dec-progress');
      const statusEl = $('#dec-status');
      const initialLabel = 'Desencriptar';

      btn.addEventListener('click', async () => {
        try{
          if (!fileEl.files?.length) throw new Error('Selecciona el archivo encriptado.');
          if (!passEl.value) throw new Error('Ingresa la contraseña.');
          const fd = new FormData();
         
          fd.append('password', passEl.value);
           fd.append('file', fileEl.files[0]);

          const {blob, resp} = await downloadWithProgress({
            url: API_BASE + ENDPOINTS.decrypt,
            formData: fd,
            button: btn,
            progressEl, statusEl,
            initialLabel
          });
          const name = triggerDownload(blob, resp);
          statusEl.textContent = `Completado: ${name}`;
          btn.textContent = 'Completado ✓';
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1200);
        }catch(err){
          console.error(err);
          statusEl.textContent = 'Error: ' + (err?.message || err);
          btn.textContent = 'Error';
          setBusy(btn, false);
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1500);
        }
      });
    })();

    // =========================
    // ENCRIPTAMIENTO MASIVO
    // =========================
    (function setupMassive(){
      const filesEl = $('#mass-files');
      const csvEl = $('#mass-csv');
      const passEl = $('#mass-pass');
      const btn = $('#mass-btn');
      const progressEl = $('#mass-progress');
      const statusEl = $('#mass-status');
      const initialLabel = 'Encriptar';

      btn.addEventListener('click', async () => {
        try{
          if (!filesEl.files?.length) throw new Error('Selecciona al menos un archivo.');
          const fd = new FormData();
          // múltiples archivos como "file"
          [...filesEl.files].forEach(f => fd.append('file', f));
          if (csvEl.files?.length) fd.append('passwords', csvEl.files[0]);
          if (passEl.value) fd.append('password', passEl.value);

          const {blob, resp} = await downloadWithProgress({
            url: API_BASE + ENDPOINTS.massive,
            formData: fd,
            button: btn,
            progressEl, statusEl,
            initialLabel
          });
          const name = triggerDownload(blob, resp);
          statusEl.textContent = `Completado: ${name}`;
          btn.textContent = 'Completado ✓';
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1200);
        }catch(err){
          console.error(err);
          statusEl.textContent = 'Error: ' + (err?.message || err);
          btn.textContent = 'Error';
          setBusy(btn, false);
          setTimeout(()=> resetUI(btn, progressEl, statusEl, initialLabel), 1500);
        }
      });
    })();
  </script>
</body>
</html>
